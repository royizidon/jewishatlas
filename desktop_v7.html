<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jewish Atlas</title>

  <!-- load your proxy URL -->
  <script src="config.js"></script>
  <!-- ArcGIS CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
  <!-- ArcGIS JS -->
  <script src="https://js.arcgis.com/4.26/"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Helvetica Neue', sans-serif;
      overflow: hidden;
    }
    /* fixed header */
    #appHeader {
      position: fixed; top: 0; left: 0; right: 0;
      height: 50px; background: #fff; border-bottom: 1px solid #ddd;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    /* map beneath header */
    #viewDiv {
      position: absolute; top: 50px; left: 0; right: 0; bottom: 0;
    }

    /* ——— Google-Maps-style Search Widget ——— */
    .esri-search {
      width: 340px !important;
      font-size: 16px;
    }
    .esri-search .esri-search__container {
      background: #fff !important;
      border: none !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      border-radius: 28px !important;
      overflow: hidden;
    }
    .esri-search__input-container {
      border: none !important;
    }
    .esri-search__input {
      height: 46px !important;
      padding: 0 18px !important;
      font-size: 16px !important;
      color: #333;
    }
    .esri-search__submit-button {
      color: #777 !important;
      padding: 0 14px !important;
    }
    .esri-search__toggle-button,
    .esri-search__clear-button {
      display: none !important;
    }

    /* floating filter toolbar */
    .filter-div {
      display: flex; gap: 6px; padding: 6px 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .filter-div .filterBtn {
      padding: 6px 12px;
      border: 2px solid #ccc;
      border-radius: 20px;
      background: #fff;
      color: #555;
      font-size: 14px;
      cursor: pointer;
      transition: 0.15s;
    }
    /* legend colors */
    .filterBtn[data-cat=""]                  { --c: #aaa; }
    .filterBtn[data-cat="Synagogue"]         { --c: #5DADE2; }
    .filterBtn[data-cat="Heritage"]          { --c: #EC7063; }
    .filterBtn[data-cat="Community"]         { --c: #F5B041; }
    .filterBtn[data-cat="Kosher Restaurant"] { --c: #58D68D; }
    /* initial: all colored */
    .filter-div:not(.filtered) .filterBtn {
      background: var(--c); border-color: var(--c); color: #fff;
    }
    /* after click: only active colored */
    .filter-div.filtered .filterBtn:not(.active) {
      background: #fff; border-color: #ccc; color: #555;
    }
    .filterBtn.active {
      background: var(--c); border-color: var(--c); color: #fff;
    }
  </style>
</head>
<body>
  <div id="appHeader">Jewish Atlas</div>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer",
      "esri/widgets/Search", "esri/widgets/Locate",
      "esri/widgets/Home", "esri/widgets/Zoom"
    ], (Map, MapView, FeatureLayer, Search, Locate, Home, Zoom) => {

      const map = new Map({ basemap: "topo-vector" });
      const view = new MapView({
        container: "viewDiv",
        map,
        center: [35.21, 31.78],
        zoom: 7,
        ui: { components: [] }
      });

      // 1) landmarks layer
      const layer = new FeatureLayer({
        url: window.LANDMARKS_URL,
        renderer: {
          type: "unique-value",
          field: "main_category",
          defaultSymbol: {
            type: "simple-marker", style: "circle",
            color: "#aaa", size: 6,
            outline: { color: "#fff", width: 1 }
          },
          uniqueValueInfos: [
            { value: "Synagogue", symbol: { type: "simple-marker", style: "circle", color: "#5DADE2", size: 6 } },
            { value: "Heritage", symbol: { type: "simple-marker", style: "circle", color: "#EC7063", size: 6 } },
            { value: "Community", symbol: { type: "simple-marker", style: "circle", color: "#F5B041", size: 6 } },
            { value: "Kosher Restaurant", symbol: { type: "simple-marker", style: "circle", color: "#58D68D", size: 6 } }
          ]
        },
        labelingInfo: [{
          labelExpressionInfo: { expression: "$feature.eng_name" },
          labelPlacement: "above-center",
          symbol: {
            type: "text", color: "#333",
            haloColor: "#fff", haloSize: 1,
            font: { size: 12, family: "Arial", weight: "bold" }
          },
          minScale: 15000
        }],
        popupTemplate: {
          title: "{Name}",
          content:
            "<p><strong>Category:</strong> {main_category}</p>" +
            "<p><strong>Address:</strong> {Address}</p>"
        }
      });
      map.add(layer);

      // 2) Search widget
      const search = new Search({
        view,
        allPlaceholder: "Search Jewish Sites…",
        includeDefaultSources: true,
        sources: [{
          layer,
          searchFields: ["eng_name"],
          displayField: "eng_name",
          exactMatch: false,
          outFields: ["*"],
          name: "Jewish Landmarks",
          placeholder: "e.g., Mikveh Israel"
        }]
      });
      view.ui.add(search, "top-left");

      // 3) Imagery toggle
      const imageBtn = document.createElement("div");
      imageBtn.className = "esri-widget esri-widget--button esri-interactive";
      imageBtn.title = "Toggle Imagery Basemap";
      imageBtn.innerHTML = '<i class="fas fa-image"></i>';
      let isImagery = false;
      imageBtn.onclick = () => {
        map.basemap = isImagery ? "topo-vector" : "hybrid";
        isImagery = !isImagery;
      };

      // 4) Filter toolbar
      const filterDiv = document.createElement("div");
      filterDiv.className = "filter-div";
      const cats = [
        { name: "All",         cat: "" },
        { name: "Synagogues",  cat: "Synagogue" },
        { name: "Heritage",    cat: "Heritage" },
        { name: "Kosher Food", cat: "Kosher Restaurant" },
        { name: "Community",   cat: "Community" }
      ];
      cats.forEach((o, i) => {
        const btn = document.createElement("button");
        btn.textContent = o.name;
        btn.className = "filterBtn" + (i === 0 ? " active" : "");
        btn.setAttribute("data-cat", o.cat);
        btn.addEventListener("click", () => {
          if (!o.cat) {
            filterDiv.classList.remove("filtered");
            layer.definitionExpression = "";
          } else {
            filterDiv.classList.add("filtered");
            layer.definitionExpression = `main_category = '${o.cat}'`;
          }
          filterDiv.querySelectorAll(".filterBtn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
        filterDiv.appendChild(btn);
      });
      view.ui.add(filterDiv, "top-right");

      // 5) Bottom-right widgets
      view.ui.add(new Zoom({ view }), {
        position: "bottom-right", index: 0
      });
      view.ui.add(imageBtn, {
        position: "bottom-right", index: 1
      });
      view.ui.add(new Locate({ view }), {
        position: "bottom-right", index: 2
      });
      view.ui.add(new Home({ view }), {
        position: "bottom-right", index: 3
      });
    });
  </script>
</body>
</html>
