<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jewish Atlas</title>

  <!-- LOAD CONFIG -->
  <script src="config.js"></script>

  <!-- ArcGIS JS & CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.26/"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      font-family: 'Helvetica Neue', sans-serif;
    }
    #appHeader {
      position: fixed; top: 0; left: 0; right: 0;
      height: 50px; background: #fff; border-bottom:1px solid #ddd;
      display: flex; align-items:center; justify-content:center;
      font-weight: bold; z-index:1000;
    }
    #viewDiv {
      position: absolute; top:50px; left:0; right:0; bottom:0;
    }
    .filter-div {
      position:absolute; top:60px; right:10px;
      display:flex; gap:6px; padding:6px 10px;
      background:rgba(255,255,255,0.95);
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index:1000;
    }
    .filterBtn {
      padding:6px 12px; border:2px solid #ccc;
      border-radius:20px; background:#fff; color:#555;
      font-size:14px; cursor:pointer;
      transition: background 0.2s, color 0.2s;
    }
    .filterBtn.active { color:#fff; }
    .filterBtn[data-cat="Featured"]         { --c:#f39c12; }
    .filterBtn[data-cat="Synagogue"]        { --c:#5DADE2; }
    .filterBtn[data-cat="Heritage"]         { --c:#EC7063; }
    .filterBtn[data-cat="Community"]        { --c:#F5B041; }
    .filterBtn[data-cat="Kosher Restaurant"]{ --c:#58D68D; }
    .filter-div:not(.filtered) .filterBtn {
      background:var(--c); border-color:var(--c);
    }
    .filter-div.filtered .filterBtn:not(.active) {
      background:#fff; border-color:#ccc; color:#555;
    }
  </style>
</head>
<body>
  <div id="appHeader">Jewish Atlas</div>
  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map", "esri/views/MapView", "esri/geometry/Extent",
      "esri/layers/FeatureLayer", "esri/Graphic",
      "esri/widgets/Search", "esri/widgets/Locate", "esri/widgets/Home", "esri/widgets/Zoom"
    ], (Map, MapView, Extent, FeatureLayer, Graphic, Search, Locate, Home, Zoom) => {

      const map = new Map({ basemap: "topo-vector" });
      const view = new MapView({
        container: "viewDiv",
        map,
        extent: new Extent({
          xmin: -20037508, ymin: -20037508,
          xmax:  20037508, ymax:  20037508,
          spatialReference: { wkid: 102100 }
        }),
        ui: { components: [] }
      });

      // ─── UI BUTTONS ───────────────────────────────────────────
      const imageBtn = document.createElement("div");
      imageBtn.className = "esri-widget esri-widget--button esri-interactive";
      imageBtn.title = "Toggle Imagery Basemap";
      imageBtn.innerHTML = '<i class="fas fa-image"></i>';
      let isImagery = false;
      imageBtn.onclick = () => {
        map.basemap = isImagery ? "topo-vector" : "hybrid";
        isImagery = !isImagery;
      };
      view.ui.add(new Zoom({ view }),    { position: "bottom-right", index: 0 });
      view.ui.add(imageBtn,              { position: "bottom-right", index: 1 });
      view.ui.add(new Locate({ view }),  { position: "bottom-right", index: 2 });
      view.ui.add(new Home({ view }),    { position: "bottom-right", index: 3 });

      // ─── SEARCH WIDGET ────────────────────────────────────────
      const search = new Search({
        view,
        allPlaceholder: "Search Jewish Sites…",
        includeDefaultSources: false,
        sources: []
      });
      view.ui.add(search, "top-left");

      // ─── FILTER TOOLBAR ───────────────────────────────────────
      const cats = [
        { name: "Featured",      cat: "Featured" },
        { name: "All",           cat: "" },
        { name: "Synagogues",    cat: "Synagogue" },
        { name: "Heritage",      cat: "Heritage" },
        { name: "Kosher Food",   cat: "Kosher Restaurant" },
        { name: "Community",     cat: "Community" }
      ];
      const filterDiv = document.createElement("div");
      filterDiv.className = "filter-div";
      cats.forEach((o,i) => {
        const btn = document.createElement("button");
        btn.textContent = o.name;
        btn.className = "filterBtn" + (i === 0 ? " active" : "");
        btn.dataset.cat = o.cat;
        filterDiv.append(btn);
      });
      view.ui.add(filterDiv);

      // ─── LOAD TEMPLATE LAYER FOR SYMBOLS & POPUPS ────────────
      const templateFL = new FeatureLayer({
        url: window.LANDMARKS_SERVICE_URL
      });

      templateFL.when(() => {
        console.log("✅ Template layer loaded. Fetching proxy data...");

        const proxyUrl = `${window.LANDMARKS_PROXY_URL}?where=1=1&outFields=*&f=json`;
        fetch(proxyUrl)
          .then(res => res.json())
          .then(data => {
            console.log(`✅ Loaded ${data.features.length} features from proxy`);

            // 1) Build an array of Graphic objects from your raw JSON
            const graphics = data.features.map(f => new Graphic({
              geometry:   f.geometry,
              attributes: f.attributes
            }));

            // 2) Create a client-side FeatureLayer with `source`
            const clientFL = new FeatureLayer({
              source:               graphics,
              fields:               data.fields,
              objectIdField:        data.objectIdFieldName,
              geometryType:         data.geometryType,
              spatialReference:     { wkid: 102100 },
              renderer:             templateFL.renderer,
              labelingInfo:         templateFL.labelingInfo,
              popupTemplate:        templateFL.popupTemplate
            });

            // 3) Add it to the map
            map.add(clientFL);

            // 4) Zoom to your graphics when ready
            view.whenLayerView(clientFL).then(() => {
              view.goTo(graphics).catch(console.error);
            });

            // 5) Hook up the Search widget
            search.sources = [{
              layer:        clientFL,
              searchFields: ["eng_name"],
              displayField: "eng_name",
              exactMatch:   false,
              outFields:    ["*"],
              name:         "Jewish Landmarks",
              placeholder:  "e.g., Mikveh Israel"
            }];

            // 6) Wire up your filter buttons
            filterDiv.querySelectorAll(".filterBtn").forEach(btn => {
              btn.addEventListener("click", () => {
                const cat = btn.dataset.cat;
                clientFL.definitionExpression = cat
                  ? `main_category='${cat}'`
                  : "";
                filterDiv.classList.toggle("filtered", !!cat);
                filterDiv.querySelectorAll(".filterBtn")
                         .forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
              });
            });

          })
          .catch(err => console.error("❌ Proxy fetch failed:", err));
      });

    });
  </script>
</body>
</html>
